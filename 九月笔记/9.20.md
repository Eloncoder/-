# Linux ln命令：建立软硬链接文件  
文件三要素：
1. 文件名
2. 文件内容
3. inode

inode包含文件的各种信息    
inode组成的inode table存放在一个位置  
文件数据块存放在另一个位置  
![image](https://user-images.githubusercontent.com/63440757/191256483-a0c5424b-69b9-4755-9c1d-c4d21e7c375d.png)

inode不包含文件名，文件名存放在文件夹信息的结构体里。文件名相当于inode的别名，便于我们管理和记忆。Linux系统对文件的操作都是通过inode做到的。  
当我们修改文件时，系统从文件夹的信息结构体里找到文件名对应的inode，再通过存储在inode中的文件数据block地址找到对应的硬盘位置进行读写操作。

## 硬链接
一般来说，inode与文件名、文件数据是一对一的关系，但我们可以通过shell命令让多个文件名指向同一个inode，这种就是硬链接（hard link）。  
`ln test.txt test_hard.txt`   
创建硬链接前，test.txt可以这样表示：            
![image](https://user-images.githubusercontent.com/63440757/191258162-a7396378-6337-40d0-b384-f80fb2af2872.png)

创建硬链接后：          
![image](https://user-images.githubusercontent.com/63440757/191258262-183b064f-2ada-4e1b-9431-b02819e32b3c.png)

可以看到，test_hard.txt的inode跟源文件test.txt使用的是同一个，只是现在链接数变成2了。  
我们可以执行`ls -li`查看一下：  
![1663677432519](https://user-images.githubusercontent.com/63440757/191259331-ed66eea2-a0d2-4230-9ef6-dd5bb733e43c.png)

第一列是inode number，可以看到都是205640491，所以两个文件使用的是同一个inode。  
第二列是权限信息（-rw-r--r--），第三列是链接数（2），第四列是拥有者（songqch）。  
第五列（platform），第六列是文件大小（0），最后是时间（9月20日，20.34）  
当在里面添加内容后：  
![1663677955271](https://user-images.githubusercontent.com/63440757/191261199-056295d7-f7df-4f4a-a075-05b77eedb52b.png)

两个文件里面的内容相同

## 软链接
准确来说叫符号链接（symbolic link），一般又叫软链接（soft link）。   
与硬链接共用一个inode不同，软链接会创建 **新的inode**，并指向源文件。可以理解软链接就是windows系统中的**桌面快捷方式**。

创建软链接的命令和硬链接很像，多了`-s`参数：   

```
ln -s test.txt test_symbolic.txt
```
![1663718909093](https://user-images.githubusercontent.com/63440757/191386128-7f9e508c-eece-4ddb-a78f-ea8a0e287e95.png)  

创建软链接之后：   
![image](https://user-images.githubusercontent.com/63440757/191385557-de26d3f8-2ebe-4ef9-9655-d5bda3b7101e.png)

源文件inode的链接数还是1，创建了新的inode，软链接指向源文件。

可以看到，软链接的inode number跟源文件的不一样，权限一列开头为小写l，表示软链，链接数为1，大小为8个字节。
没错，软链文件也有大小，不过一般很小，毕竟只是一个快捷方式。

## 对比
### 文件重命名或文件移动
文件重命名和文件移动对于Linux系统来说都是文件绝对路径的更改。对硬链接来说，文件重命名或文件移动不会改变链接指向，而对软链接来说，文件重命名或文件移动则使链接断开，这时通过软链接修改文件内容时会重新创建一个新的inode，跟原文件名和文件数据块关联。

### 文件删除
rm命令或者nodejs的unlink其实是将inode的链接数减1。对于前文的硬链接，删除test_hard.txt使得inode1的链接数变成1，当链接数变成0时，系统就会释放掉这个inode，之后再创建的新文件就可以使用该inode的inode number了。这时没有inode指向文件数据block，所以文件找不到了。但实际上文件数据还存在硬盘中，所以经常能看到网上有一些帮助恢复误删的文件的工具。软链接inode链接数为1，删除软链接则系统释放该inode。

### 链接文件和文件夹
软链接可以链接文件和文件夹，但硬链接只能链接文件。

### 不同文件系统创建链接
软链接可以跨不同的文件系统创建，但是硬链接不行，因为硬链接是共用一个inode，而不同的文件系统有不同的inode table。

## 应用场景
### 硬链接
文件备份：为了防止重要的文件被误删，文件备份是一种好的办法，但拷贝文件会带来磁盘空间的消耗。硬链接能不占用磁盘空间实现文件备份。

文件共享：多人共同维护同一份文件时，可以通过硬链接的方式，在私人目录里创建硬链接，每个人的修改都能同步到源文件，但又避免某个人误删就丢掉了文件的问题。

文件分类：不同的文件资源需要分类，比如某个电影即是的分类是外国、悬疑，那我们可以在外国的文件夹和悬疑的文件夹里分别创建硬链接，这样可以避免重复拷贝电影浪费磁盘空间。有人可能说，使用软链接不也可以吗？是的，但不太好。因为一旦源文件移动位置或者重命名，软链接就失效了。

### 软链接
快捷方式：对于路径很深的文件，查找起来不太方便。利用软链接在桌面创建快捷方式，可以迅速打开并编辑文件。

灵活切换程序版本：对于机器上同时存在多个版本的程序，可以通过更改软链接的指向，从而迅速切换程序版本。这里提到了python版本的切换可以这么做。

动态库版本管理：不是很懂，具体可以看这里。

## 总结
Linux系统通过inode管理文件，inode存储着文件字节数、文件权限、链接数、数据block位置等信息。

硬链接与源文件共用inode，除了文件名不同，其他与源文件一样。不能对文件夹创建硬链接，不能对不同的文件系统的文件创建硬链接。

软链接类似于windows的快捷方式，有独立的inode。可以对文件夹或不同文件系统的文件创建软链接。

硬链接和软链接修改文件内容都会同步到源文件，因为本质上它们都是指向源文件的数据block。
